---
  ### ---------------------------------------------------------------------------
  ### APSTRA API AUTOMATION
  ### ---------------------------------------------------------------------------
  - hosts: localhost
    gather_facts: False
    connection: local
    roles:
      - { role: apstra_auth }
      - { role: get_bp_id }

    tasks:
    - name: Initialize Variables
      ansible.builtin.set_fact: 
        leaf_ids: ""

    - name: Get Device ID
      ansible.builtin.include_role:
        name: get_node_system
      vars:
        node_type: system

    - name: set system id
      ansible.builtin.set_fact:
        leaf_ids: "{{ node_system.json }}"
      when: leaf_ids == ""

    - name:
      debug:
        var: leaf_ids

    - name: Get id of the system with specific label
      ansible.builtin.set_fact:
        leaf_id: "{{ leaf_ids.nodes | dict2items }}"

    - name:
      debug:
        var: leaf_id

    - name: Initialize empty list for ids
      set_fact:
        specific_ids: []

    - name: Add ids to specific_ids list
      set_fact:
        specific_ids: "{{ specific_ids + [item.value.id] }}"
      loop: "{{ leaf_id }}"
      when: item.value.label in leaf_name

    - name: Display specific_ids
      debug:
        var: specific_ids

    - name: Template'i hedef makinelerde kullan
      template:
        src: templates/create_vn.j2
        dest: /create_vn.j2

    - name: "Create connectivity template"
      uri:
        url: "{{ apstra.baseurl }}/blueprints/{{ bp_id }}/virtual-networks-batch?async=full"
        method: POST
        status_code: 202
        headers:
          content-type: "application/json"
          AUTHTOKEN: "{{ login.json.token }}"
        validate_certs: false
        force_basic_auth: yes
        body: "{{ lookup('ansible.builtin.template','templates/create_vn.j2') }}"
        body_format: json
      ignore_errors: yes
#
#
#
#
#
#### ---------------------------------------------------------------------------
#### ASSIGN EVPN L3 VNIS
#### ---------------------------------------------------------------------------
#    - name: "Assign EVPN L3 VNIs"
#      uri:
#        url: "{{ apstra.baseurl }}/blueprints/{{ bp_id }}/resource_groups/vni/evpn_l3_vnis"
#        method: PUT
#        status_code: 202
#        headers:
#          content-type: "application/json"
#          AUTHTOKEN: "{{ login.json.token }}"
#        validate_certs: false
#        body: '{"pool_ids":["Default-10000-20000"]}'
#        body_format: json
#
    - name: "Commit Changes"
      include_role:
        name: commit_changes
